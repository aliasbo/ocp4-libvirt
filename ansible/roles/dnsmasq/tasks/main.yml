---
#  tasks
- name: Install dnsmasq and ipxe bootimgs
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ packages }}"

- name: Deploy dnsmasq main config
  template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.conf
    mode: 0644

- name: Deploy dnsmasq main cluster config
  template:
    src: main.conf.j2
    dest: "/etc/dnsmasq.d/{{ ocp_name }}-main.conf"
    mode: 0644

- name: Deploy dnsmasq bootstrap configs
  template:
    src: "bootstrap.conf.j2"
    dest: "/etc/dnsmasq.d/{{ ocp_name }}-bootstrap.conf"
    mode: 0644

- name: Deploy dnsmasq worker configs
  template:
    src: "workers.conf.j2"
    dest: "/etc/dnsmasq.d/{{ ocp_name }}-workers.conf"
    mode: 0644
  when: groups['workers'] | length > 0

- name: Disable dns in NetworkManager
  lineinfile:
    path: "{{ networkmanager_config }}"
    insertafter: "^\\[main\\]"
    line: "dns=none"
    state: present

- name: Set resolution to itself in resolv.conf
  shell: echo -e "search {{ ocp_domain }}\nnameserver 127.0.0.1" > /etc/resolv.conf
  register: echo_result
  changed_when: "echo_result.rc == 0"

- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted

- name: Enable dnsmasq
  service:
    name: dnsmasq
    enabled: yes

- name: Start dnsmasq
  service:
    name: dnsmasq
    state: restarted
